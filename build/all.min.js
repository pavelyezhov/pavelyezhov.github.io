!function(){return function e(t,i,s){function n(r,o){if(!i[r]){if(!t[r]){var h="function"==typeof require&&require;if(!o&&h)return h(r,!0);if(a)return a(r,!0);var c=new Error("Cannot find module '"+r+"'");throw c.code="MODULE_NOT_FOUND",c}var l=i[r]={exports:{}};t[r][0].call(l.exports,function(e){var i=t[r][1][e];return n(i||e)},l,l.exports,e,t,i,s)}return i[r].exports}for(var a="function"==typeof require&&require,r=0;r<s.length;r++)n(s[r]);return n}}()({1:[function(e,t,i){"use strict";var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"green",a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:900,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:50,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:100,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:100,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:"up",u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;r(this,e),this.ctx=t,this.width=i,this.height=s,this.imgWidth=h,this.imgHeight=c,this.color=n,this.speed=0,this.angle=0,this.moveAngle=0,this.x=a,this.y=o,this.sprites=[].slice.call(document.querySelectorAll(".person-img")),this.spriteNum=0,this.moveDirection=l,this.i=u}return s(e,[{key:"getSprite",value:function(){return this.spriteNum=(this.spriteNum+1)%this.sprites.length,this.sprites[this.spriteNum]}},{key:"getBackGround",value:function(){return[].slice.call(document.getElementsByTagName("img"))[3]}},{key:"update",value:function(e){e.save(),e.save(),e.translate(this.x,this.y);var t=this.getPersonImg();return e.drawImage(this.getSprite(),t.sx,t.sy,t.sWidth,t.sHeight,this.imgWidth/-2,this.imgHeight/-2,this.imgWidth,this.imgHeight),e.restore(),this.i+=1,this.i%6==0&&(this.i=0),this}},{key:"newPos",value:function(e){this.moveAngle=0,this.speed=0,this.deltaX=0,this.deltaY=0;e.left&&(this.deltaX=-10)&&(this.moveDirection="left"),e.right&&(this.deltaX=10)&&(this.moveDirection="right"),e.up&&(this.deltaY=10)&&(this.moveDirection="up"),e.down&&(this.deltaY=-10)&&(this.moveDirection="down");return this.x+=this.deltaX,this.y-=this.deltaY,x=this.x,I=this.y,this.x>k?this.x=0:this.x<0&&(this.x=k),this.y>w?this.y=0:this.y<0&&(this.y=w),this}},{key:"getPersonImg",value:function(){return"up"===this.moveDirection?g.getUpSettings()[this.i]:"down"===this.moveDirection?g.getDownSettings()[this.i]:"left"===this.moveDirection?g.getLeftSettings()[this.i]:"right"===this.moveDirection?g.getRightSettings()[this.i]:g.getDownSettings()[this.i]}}]),e}(),h=function(e){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"red",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:600,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:300,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:5,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:200;r(this,t);var d=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return d.ctx=e,d.width=i,d.height=s,d.color=a,d.angle=0,d.moveAngle=0,d.x=o,d.y=h,d.speedV=c,d.speedH=l,d.visionRadius=u,d}return a(t,o),s(t,[{key:"newPos",value:function(){var e,t,i,s,n,a,r,o,h,c;return this.heroInVision()?(r=this.x,o=3,c=0===(h=x-r)?0:h>0?1:-1,e=Math.abs(h)<o?c:c*o,i=this.y,s=3,a=0===(n=I-i)?0:n>0?1:-1,t=Math.abs(n)<s?0:a*s):(e=this.speedH,t=this.speedV),this.x+=e,this.y+=t,this.x>k?this.x=0:this.x<0&&(this.x=k),this.y>w?this.y=0:this.y<0&&(this.y=w),this}},{key:"xPlusDelta",value:function(e,t){return e+t<0?0:e+t>k?k:e+t}},{key:"yPlusDelta",value:function(e,t){return e+t<0?0:e+t>w?w:e+t}},{key:"update",value:function(e){var t=this.x,i=this.y;return e.save(),e.translate(this.x,this.y),e.rotate(this.angle),e.fillStyle=this.color,e.fillRect(this.width/-2,this.height/-2,this.width,this.height),e.restore(),e.beginPath(),e.arc(t,i,this.visionRadius,0,2*Math.PI,!1),e.lineWidth=1,e.strokeStyle="#003300",e.stroke(),this}},{key:"heroInVision",value:function(){var e=x-this.x,t=I-this.y;return Math.sqrt(Math.pow(e,2)+Math.pow(t,2))<=this.visionRadius}},{key:"getItemType",value:function(){return"EnemyType1"}}]),t}();var c,l,u=function(e){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"blue",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:400,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:400;r(this,t);var c=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return c.ctx=e,c.width=i,c.height=s,c.color=a,c.speed=0,c.angle=0,c.moveAngle=0,c.x=o,c.y=h,c}return a(t,o),s(t,[{key:"newPos",value:function(){return this.x+=2,this.x>k?this.x=0:this.x<0&&(this.x=k),this.y>w?this.y=0:this.y<0&&(this.y=w),this}},{key:"update",value:function(e){return e.save(),e.translate(this.x,this.y),e.rotate(this.angle),e.fillStyle=this.color,e.fillRect(this.width/-2,this.height/-2,this.width,this.height),e.restore(),this}},{key:"getItemType",value:function(){return"EnemyType2"}}]),t}(),d=function(){function e(){r(this,e)}return s(e,[{key:"init",value:function(){console.log("INIT: "),this.database=firebase.database(),this.framesRef=this.database.ref("frame"),this.framesRef.off()}},{key:"loadItems",value:function(e){return console.log("Data: "),this.framesRef=this.database.ref("frame"),this.framesRef.off(),this.framesRef}},{key:"loadGame",value:function(e){return this.gameRef=this.database.ref("games/"+e),this.gameRef.off(),this.gameRef}},{key:"loadGames",value:function(){return this.database||(this.database=firebase.database()),this.gamesRef=this.database.ref("games"),this.gamesRef.off(),this.gamesRef}},{key:"saveFrame",value:function(e,t,i){this.framesRef=this.database.ref("frames"),this.framesRef.off(),this.database.ref("frame/"+e+t).set({content:JSON.stringify(i)})}},{key:"saveGame",value:function(e,t,i){var s=this;this.gamesRef=this.database.ref("games"),this.gamesRef.off(),this.loadGames().once("value").then(function(n){var a;a=n.val()&&Object.values(n.val())?Object.values(n.val()).length+1:1,s.database.ref("games/"+a).set({game:JSON.stringify(e),player:i,score:t,time:Date.now()})})}},{key:"getFrameObjectsByFrameIdAndType",value:function(e,t){return this.framesRef=this.database.ref("frame"),this.framesRef.off(),this.framesRef.child(e+t)}}]),e}(),m=function(){function e(){r(this,e),this.frameStoreId="frameStoreId",this.playerRecordsId="playerRecordsId",this.storage=localStorage}return s(e,[{key:"getStoredData",value:function(e){return JSON.parse(this.storage.getItem(e))}},{key:"saveObject",value:function(e,t){var i=this.getStoredData(this.frameStoreId);return null===i&&(i=[]),i[t]||(i[t]={enemies1:[],enemies2:[],hero:{}}),this.addItemToStore(e,i[t]),this.storage.setItem(this.frameStoreId,JSON.stringify(i)),e}},{key:"addItemToStore",value:function(e,t){e instanceof h?t.enemies1.push(e):e instanceof u?t.enemies2.push(e):e instanceof o&&(t.hero=e)}},{key:"getItemsByFrameId",value:function(e){return JSON.parse(this.storage.getItem(this.frameStoreId))[e]}},{key:"clearFrames",value:function(){this.getStoredData(this.frameStoreId);this.storage.setItem(this.frameStoreId,JSON.stringify(null))}},{key:"saveRecord",value:function(e,t){var i=this.getStoredData("playerRecordsId");null===i&&(i={});var s=i[t];(!s||s<e)&&(i[t]=e),this.storage.setItem(this.playerRecordsId,JSON.stringify(i))}}]),e}(),f=function(){function e(t){r(this,e),this.dao=t}return s(e,[{key:"createRecordTableEl",value:function(){var e=document.createElement("table");return e.className="recordTable",e.innerHTML=this.createRecordTableHTML(),e.id="recordTableId",e}},{key:"createRecordTableHTML",value:function(){var e='<table  class="table"><thead><tr><th>Player</th><th>Score</th></tr></thead><tbody>',t=this.dao.getStoredData("playerRecordsId");for(var i in t)e+="<tr><td>"+i+"</td><td>"+t[i]+"</td></tr>";return e+="</tbody></table>"}},{key:"createReplayTableHTML",value:function(e){for(var t='<table class="table"><thead><tr><th>Player</th><th>Score</th><th>Time</th></tr></thead><tbody>',i=0;i<e.length;i++){var s=e[i].player,n=e[i].score,a=e[i].time;t+="<tr id="+(i+1)+'><td><a href="#/showGame">'+s+"</a></td><td>"+n+"</td><td>"+new Date(a).toLocaleString()+"</td></tr>"}return t+="</tbody></table>"}},{key:"makePlayLastGameButtonVisible",value:function(){document.getElementById("controlsArea").className="passive",document.getElementById("replayArea").className="replayArea active"}}]),e}(),v=function(){function e(){r(this,e),this.frames=[]}return s(e,[{key:"saveHero",value:function(e,t){this.frames[t]||this.initFrame(t),this.frames[t].hero=JSON.stringify(e)}},{key:"saveEnemy",value:function(e,t){this.frames[t]||this.initFrame(t),this.frames[t].enemies.push(JSON.stringify(e))}},{key:"initFrame",value:function(e){0===this.frames.length?(this.frames.push({hero:{},enemies:[]}),this.frames.push({hero:{},enemies:[]})):this.frames[e]={hero:{},enemies:[]}}}]),e}(),g=function(){function e(){r(this,e)}return s(e,null,[{key:"getUpSettings",value:function(){return[{sx:0,sy:200,sWidth:100,sHeight:100},{sx:100,sy:200,sWidth:100,sHeight:100},{sx:200,sy:200,sWidth:100,sHeight:100},{sx:300,sy:200,sWidth:100,sHeight:100},{sx:400,sy:200,sWidth:100,sHeight:100},{sx:500,sy:200,sWidth:100,sHeight:100}]}},{key:"getDownSettings",value:function(){return[{sx:0,sy:0,sWidth:100,sHeight:100},{sx:100,sy:0,sWidth:100,sHeight:100},{sx:200,sy:0,sWidth:100,sHeight:100},{sx:300,sy:0,sWidth:100,sHeight:100},{sx:400,sy:0,sWidth:100,sHeight:100},{sx:500,sy:0,sWidth:100,sHeight:100}]}},{key:"getLeftSettings",value:function(){return[{sx:0,sy:300,sWidth:100,sHeight:100},{sx:100,sy:300,sWidth:100,sHeight:100},{sx:200,sy:300,sWidth:100,sHeight:100},{sx:300,sy:300,sWidth:100,sHeight:100},{sx:400,sy:300,sWidth:100,sHeight:100},{sx:500,sy:300,sWidth:100,sHeight:100}]}},{key:"getRightSettings",value:function(){return[{sx:0,sy:100,sWidth:100,sHeight:100},{sx:100,sy:100,sWidth:100,sHeight:100},{sx:200,sy:100,sWidth:100,sHeight:100},{sx:300,sy:100,sWidth:100,sHeight:100},{sx:400,sy:100,sWidth:100,sHeight:100},{sx:500,sy:100,sWidth:100,sHeight:100}]}}]),e}(),y=function(){function e(t){r(this,e),this.routes=t.routes||[],this.eventBus=t.eventBus,this.init()}return s(e,[{key:"init",value:function(){var e=this;window.addEventListener("hashchange",function(){return e.handleUrl(window.location.hash)}),this.handleUrl(window.location.hash)}},{key:"findPreviousActiveRoute",value:function(){return this.currentRoute}},{key:"findNewActiveRoute",value:function(e){var t=e.split("#").pop();return this.routes.find(function(e){return"string"==typeof e.match?e.match===t:e.match instanceof RegExp?e.match.test(t):"function"==typeof e.match?e.match(t):void 0})}},{key:"getRouteParams",value:function(e,t){var i=t.match(e.match)||[];return i.shift(),i}},{key:"handleUrl",value:function(e){e=e.slice(1);var t=this.findPreviousActiveRoute(),i=this.findNewActiveRoute(e),s=this.getRouteParams(i,e);t&&t.onLeave&&t.onLeave(this.currentRouteParams),i&&i.onBeforeEnter&&i.onBeforeEnter(s),i&&i.onEnter&&i.onEnter(s),this.currentRoute=i,this.currentRouteParams=s}}]),e}(),p=function(){function e(){r(this,e)}return s(e,null,[{key:"getLevels",value:function(){return[{winScoreLimit:5,imgSource:void 0,enemies:[new h,new h(this.ctx,15,15,"blue",300,600,-3)]},{winScoreLimit:10,imgSource:void 0,enemies:[new u]},{winScoreLimit:15,imgSource:void 0,enemies:[new h(this.ctx,20,20,"orange",300,800,-4)]}]}}]),e}(),b=function(){function e(t,i,s,n){r(this,e),this.fbDao=new d,this.lsDao=new m,this.fbDao.init(),this.gameCache=new v,this.drawService=new f(this.lsDao),this.stepId=0,this.score=0,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.person=new n,this.enemies=[],this.enemies.push(new h),this.enemies.push(new h(this.ctx,15,15,"blue",300,600,-3)),this.canvas.width=k,this.canvas.height=w,this.img=new Image,this.img.src="img/grass.png",this.currLvl=1,this.lvls=p.getLevels(),this.updateState()}return s(e,[{key:"start",value:function(){var e=this;this.frameNo=0,this.interval=setInterval(this.updateState.bind(this),50),window.addEventListener("keydown",function(t){t.preventDefault(),e.keys=e.keys||[],e.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){e.keys[t.keyCode]="keydown"==t.type})}},{key:"stop",value:function(){clearInterval(this.interval)}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"updateState",value:function(){var e=this;this.stepId+=1,this.stepId%10==0&&(this.score+=1,this.updateScoreArea()),this.clear(),this.anyCollisionOccurred(this.person,this.enemies)&&!this.finishGame()||(this.checkCurrentLevelPassed(),this.person.newPos({right:this.keys&&this.keys[39],left:this.keys&&this.keys[37],up:this.keys&&this.keys[38],down:this.keys&&this.keys[40]}).update(this.ctx),this.gameCache.saveHero(this.person,this.stepId),this.enemies.forEach(function(t){t.newPos().update(e.ctx),e.gameCache.saveEnemy(t,e.stepId)}))}},{key:"checkCurrentLevelPassed",value:function(){var e=this.lvls[this.currLvl-1];e&&this.score>e.winScoreLimit&&(bootbox.alert("Level "+this.currLvl+" is completed! Press ok to continue"),this.currLvl+=1,this.stop(),L(),e.enemies&&(this.enemies=this.enemies.concat(e.enemies)),this.person=new o,this.keys=void 0)}},{key:"anyCollisionOccurred",value:function(e,t){for(var i=0;i<t.length;i++)if(this.collisionOccurred(e,t[i]))return!0;return!1}},{key:"collisionOccurred",value:function(e,t){var i=!1,s=!1;return e.x+e.width/2>=t.x-t.width/2&&e.x-e.width/2<=t.x+t.width/2&&(i=!0),e.y+e.height/2>=t.y-t.height/2&&e.y-e.height/2<=t.y+t.height/2&&(s=!0),i&&s}},{key:"updateScoreArea",value:function(){document.getElementById("scoreNumber").innerHTML=this.score}},{key:"resetScore",value:function(){document.getElementById("scoreNumber").innerHTML=0}},{key:"finishGame",value:function(){this.stop();var t=prompt("Record saving","Unnamed player");t&&(this.fbDao.saveGame(this.gameCache.frames,this.score,t),this.lsDao.saveRecord(this.score,t)),L(),this.resetScore(),l=new e(this.canvas,k,w,o)}},{key:"replayLastGame",value:function(){var e=this;this.fbDao.loadGames().once("value").then(function(t){var i=Object.values(t.val()).length;e.fbDao.loadGame(i).once("value").then(function(t){e.frames=JSON.parse(Object.values(t.val())[0]),e.interval=setInterval(e.drawFrame2.bind(e),50)})})}},{key:"replaySelectedGame",value:function(e){var t=this;this.fbDao.loadGames().once("value").then(function(i){t.fbDao.loadGame(e).once("value").then(function(e){t.frames=JSON.parse(Object.values(e.val())[0]),t.interval=setInterval(t.drawFrame2.bind(t),50)})})}},{key:"drawFrame2",value:function(){var e=this,t=this.frames[this.stepId];if(!t)return this.stop(),void(this.stepId=1);this.clear();var i=JSON.parse(t.hero);new o(this.ctx,i.width,i.height,i.color,i.x,i.y,i.imgWidth,i.imgHeight,i.moveDirection,i.i).update(this.ctx),t.enemies.forEach(function(t){var i=JSON.parse(t);i.visionRadius?new h(e.ctx,i.width,i.height,i.color,i.x,i.y,i.speedV,i.speedH,i.visionRadius).update(e.ctx):new u(e.ctx,i.width,i.height,i.color,i.x,i.y).update(e.ctx)}),this.stepId++}},{key:"drawFrame",value:function(){var e=this;this.fbDao.getFrameObjectsByFrameIdAndType(this.stepId,"hero").once("value").then(function(t){e.clear();var i=JSON.parse(t.child("content").val());new o(e.ctx,i.width,i.height,i.color,i.x,i.y,i.imgWidth,i.imgHeight,i.moveDirection,i.i).update(e.ctx),e.stepId++})}}]),e}(),k=document.documentElement.clientWidth,w=document.documentElement.clientHeight,x=0,I=0,E=new m,S=(new d,new f(E)),R=[{name:"about",match:/[/]about/,onBeforeEnter:function(){N("aboutLink","active")},onEnter:function(){return console.log("onEnter about")},onLeave:function(){N("aboutLink","")}},{name:"game",match:/[/]game/,onBeforeEnter:function(){var e=document.getElementById("gameArea");e&&(e.className="gameArea active",L(),document.getElementById("replayArea").className="replayArea passive",document.getElementById("controlsArea").className="",N("gameLink","active"))},onEnter:function(){},onLeave:function(){l.stop(),document.getElementById("gameArea").className="gameArea passive",document.getElementById("controlsArea").children[0].src="img/play.png",N("gameLink",""),l.stop()}},{name:"showGame",match:/[/]showGame/,onBeforeEnter:function(){var e=document.getElementById("gameArea");e&&(e.className="gameArea active")},onEnter:function(){},onLeave:function(){document.getElementById("gameArea").className="gameArea passive",document.getElementById("controlsArea").children[0].src="img/play.png",l.stop()}},{name:"records",match:/[/]records/,onBeforeEnter:function(){var e=document.getElementById("recordsArea");e.className="active",e.style.width=document.documentElement.clientWidth,e.style.height=document.documentElement.clientHeight;var t=document.getElementById("recordTableId");t.innerHTML=S.createRecordTableHTML(),t.className="table",N("recordLink","active")},onEnter:function(){},onLeave:function(){document.getElementById("recordsArea").className="recordsArea passive",document.getElementById("recordTableId").className="tableArea passive",N("recordLink","")}},{name:"replays",match:/[/]replays/,onBeforeEnter:function(){N("replayLink","active");var e=document.getElementById("replaysPage");e.className="replaysPage active",e.style.width=document.documentElement.clientWidth,e.style.height=document.documentElement.clientHeight;var t=document.getElementById("replaysTableId");(void 0).fbDao.loadGames().once("value").then(function(e){t.innerHTML=S.createReplayTableHTML(Object.values(e.val())),t.className="table"})},onEnter:function(){return console.log("onEnter about")},onLeave:function(){N("replayLink",""),document.getElementById("replaysPage").className="replaysPage passive",document.getElementById("replaysTableId").className="tableArea passive"}}];function L(){document.getElementById("controlsArea").children[0].src="img/play.png"}function N(e,t){var i=document.getElementById(e);i.className=t,i.parentElement.className=t}!function(){location.hash="/game",w=document.documentElement.clientHeight-document.getElementsByTagName("nav")[0].clientHeight,new y({routes:R}),this.canvas=document.querySelector("canvas"),l=new b(this.canvas,k,w,o),document.getElementById("controlsArea").addEventListener("click",function(){this.children[0].src.includes("play")?(l.start(),this.children[0].src="img/pause.png"):(l.stop(),this.children[0].src="img/play.png")}),document.getElementById("replayArea").addEventListener("click",function(){c||l.replayLastGame(),l.replaySelectedGame(c)}),document.getElementById("replaysTableId").addEventListener("click",function(){"A"===event.target.tagName&&(c=Number(event.target.parentNode.parentNode.id),S.makePlayLastGameButtonVisible())})}()},{}]},{},[1]);